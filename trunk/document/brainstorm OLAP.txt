===========================

questão dos filtros:

solução:

quando ocorrer um filtro em um nó da consulta o filtro será traduzido como um case when que retornará 1 caso a expressão seja verdadeira para aquela linha da tabela e 0 quando for falso. Por exemplo: filtro TRD (CSA) - será case when (idproduto in (xxxxxx) then 1 else 0) (o alias da coluna diz qual é o nó que ele representa). Para cada linha do resultset, percorrer a descer as arvores de linhas e colunas para montar o cellset (espaço multidimensional), quando chegar num nó do tipo filtro, se o valor da coluna no resultset for 1 naquela linha, então continua descendo nos nós da arvore, para aquela linha do resultset, senão pára e parte para a próxima linha.

============================

questão das métricas com filtro:

solução:

traduz para um sum(case when exp_filtro then coluna else null). Este filtro filtra apenas níveis.

===========================

filtro de consulta traduz para cláusula WHERE.



         raiz linhas
       --------------------------
       |            |           |
       |            |           |
  Tipo Produto Categoria    TRD (CSA) (Filtro)
       |
       |
    Produto
  -----------
  |         |
  |         | 
Editor Plataforma


    raiz colunas
    ------------
          |
Quantidade de acesso
          |
         Ano


select 

--linhas
dwd_produto_eletronico.idtipoproduto as l_1, dwf_acesso.idproduto as l_1_1, 
dwf_acesso.ideditor as l_1_1_1, dwf_acesso.idplataforma as l_1_1_2,
dwf_acesso.idcategoria as l_2, 
sum(case when trd_expression then dwf_acesso.quantidade else 0) as l_3, --gerar essa coluna pras métricas do relatório,

--colunas
sum(dwf_acesso.quantidade) as c_1, year(dwf_acesso.tempo) as c_1_1

from dwf_acesso, dwd_produto_eletronico
where dwf_acesso.idproduto = dwd_produto_eletronico.idproduto
group by dwd_produto_eletronico.idtipoproduto, dwf_acesso.idproduto, 
       dwf_acesso.idplataforma, dwf_acesso.ideditor, year(dwf_acesso.tempo)


Stack stack;
CellSet cellSet;

void visit(No no) {
	for (No child: no.getChildren() {
		stack.push(no);
		visit(child);
	}

	if (!no.isChildrenSameHierarchy) {
		for (Member member: no.getMembers()) {

			for (No child: no.getChildren()) {
				cellSet += executeQuery(stack, member, child);
			}
		}
	} else {

        }
}

======== SQL =========


